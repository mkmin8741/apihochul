name: update movies

on:
  workflow_dispatch:

jobs:
  test:
    runs-on: ubuntu-latest
    steps:
    - uses: actions/checkout@v4
      with:
        token: ${{ secrets.GITHUB_TOKEN }}
    - uses: actions/setup-python@v4
      with:
        python-version: '3.9'
    - name: Quick test
      env:
        KOBIS_KEY: ${{ secrets.KOBIS_API_KEY }}
      run: |
        pip install requests
        python -c "
        import requests, json, os
        from datetime import datetime, timedelta
        
        api_key = os.environ['KOBIS_KEY']
        date = (datetime.now() - timedelta(days=1)).strftime('%Y%m%d')
        
        r = requests.get('http://www.kobis.or.kr/kobisopenapi/webservice/rest/boxoffice/searchDailyBoxOfficeList.json', 
                        params={'key': api_key, 'targetDt': date, 'itemPerPage': 10})
        
        data = {'updateTime': datetime.now().isoformat(), 'movies': r.json()['boxOfficeResult']['dailyBoxOfficeList']}
        
        with open('movies.json', 'w', encoding='utf-8') as f:
            json.dump(data, f, ensure_ascii=False, indent=2)
        
        print('âœ… ì„±ê³µ! movies.json ìƒì„± ì™„ë£Œ - Top 10 ì˜í™”')
        print(f'ğŸ“Š ì´ {len(data[\"movies\"])}ê°œ ì˜í™” ë°ì´í„° ìˆ˜ì§‘ë¨')
        "
    - name: Commit
      run: |
        git config user.name "Bot"
        git config user.email "bot@example.com"
        git add movies.json
        git commit -m "ğŸ¬ Top 10 ì˜í™” ìˆœìœ„ ì—…ë°ì´íŠ¸ $(date)" || exit 0
        git push
