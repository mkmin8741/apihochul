name: Movie Data Auto Update

on:
  schedule:
    - cron: '0 */6 * * *'  # 6ì‹œê°„ë§ˆë‹¤ (0ì‹œ, 6ì‹œ, 12ì‹œ, 18ì‹œ)
  workflow_dispatch:  # ìˆ˜ë™ ì‹¤í–‰ë„ ê°€ëŠ¥

jobs:
  update-movies:
    runs-on: ubuntu-latest
    steps:
    - uses: actions/checkout@v4
      with:
        token: ${{ secrets.GITHUB_TOKEN }}
        
    - uses: actions/setup-python@v4
      with:
        python-version: '3.9'
        
    - name: Update movie rankings
      env:
        KOBIS_KEY: ${{ secrets.KOBIS_API_KEY }}
      run: |
        pip install requests
        python -c "
        import requests, json, os
        from datetime import datetime, timedelta
        
        print('ğŸ¬ ì˜í™” ìˆœìœ„ ì—…ë°ì´íŠ¸ ì‹œì‘...')
        
        # API ì„¤ì • (ìˆ˜ì • ê°€ëŠ¥í•œ ë¶€ë¶„ë“¤)
        api_key = os.environ['KOBIS_KEY']
        target_date = (datetime.now() - timedelta(days=1)).strftime('%Y%m%d')  # ì–´ì œ ë‚ ì§œ
        movie_count = 10  # ê°€ì ¸ì˜¬ ì˜í™” ê°œìˆ˜ (1~10)
        
        print(f'ğŸ“… ì¡°íšŒ ë‚ ì§œ: {target_date}')
        print(f'ğŸ“Š ì˜í™” ê°œìˆ˜: {movie_count}ê°œ')
        
        # KOBIS API í˜¸ì¶œ
        api_url = 'http://www.kobis.or.kr/kobisopenapi/webservice/rest/boxoffice/searchDailyBoxOfficeList.json'
        params = {
            'key': api_key,
            'targetDt': target_date,
            'itemPerPage': movie_count,
            # 'repNationCd': 'K',  # í•œêµ­ì˜í™”ë§Œ ì›í•˜ë©´ ì£¼ì„ í•´ì œ
            # 'wideAreaCd': '01'   # íŠ¹ì • ì§€ì—­ë§Œ ì›í•˜ë©´ ì£¼ì„ í•´ì œ (01=ì„œìš¸)
        }
        
        response = requests.get(api_url, params=params)
        response.raise_for_status()
        result = response.json()
        
        # ë°ì´í„° ì •ë¦¬
        movie_data = {
            'updateTime': datetime.now().strftime('%Y-%m-%d %H:%M:%S'),
            'targetDate': target_date,
            'totalMovies': len(result['boxOfficeResult']['dailyBoxOfficeList']),
            'movies': result['boxOfficeResult']['dailyBoxOfficeList']
        }
        
        # JSON íŒŒì¼ ì €ì¥
        with open('movies.json', 'w', encoding='utf-8') as f:
            json.dump(movie_data, f, ensure_ascii=False, indent=2)
        
        print(f'âœ… ì„±ê³µ! {movie_data[\"totalMovies\"]}ê°œ ì˜í™” ë°ì´í„° ì—…ë°ì´íŠ¸ ì™„ë£Œ')
        print(f'ğŸ• ì—…ë°ì´íŠ¸ ì‹œê°„: {movie_data[\"updateTime\"]}')
        "
        
    - name: Commit and push
      run: |
        git config user.name "Movie Bot"
        git config user.email "moviebot@example.com"
        git add movies.json
        if git diff --staged --quiet; then
          echo "ë³€ê²½ì‚¬í•­ ì—†ìŒ"
        else
          git commit -m "ğŸ¬ ì˜í™” ìˆœìœ„ ìë™ ì—…ë°ì´íŠ¸ $(date +'%Y-%m-%d %H:%M')"
          git push
          echo "âœ… ì—…ë°ì´íŠ¸ ì™„ë£Œ"
        fi
