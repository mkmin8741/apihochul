name: IPO Data Crawler

on:
  schedule:
    - cron: '0 */3 * * *'  # 3ì‹œê°„ë§ˆë‹¤ ì‹¤í–‰
  workflow_dispatch:

jobs:
  krx-ipo-crawl:
    runs-on: ubuntu-latest
    
    steps:
    - name: Checkout repository
      uses: actions/checkout@v4
      with:
        token: ${{ secrets.GITHUB_TOKEN }}
        
    - name: Setup Python
      uses: actions/setup-python@v4
      with:
        python-version: '3.9'
        
    - name: Install dependencies
      run: |
        pip install requests beautifulsoup4 lxml pandas pykrx
        
    - name: KRX IPO data collection
      run: |
        python << 'EOF'
        import requests
        import json
        from datetime import datetime, timedelta
        import time
        import pandas as pd
        
        def create_mock_ipo_data():
            """ìž„ì‹œ IPO ë°ì´í„° ìƒì„± (ì‹¤ì œ í¬ë¡¤ë§ ì‹¤íŒ¨ì‹œ ëŒ€ì²´ìš©)"""
            try:
                print("ðŸ¢ KRX IPO ë°ì´í„° ìˆ˜ì§‘ ì‹œìž‘...")
                
                # ìž„ì‹œ IPO ë°ì´í„° (ì‹¤ì œ ìš´ì˜ì‹œì—ëŠ” ì‹¤ì œ í¬ë¡¤ë§ìœ¼ë¡œ êµì²´)
                mock_events = [
                    {
                        'date': '2025-08-08',
                        'company_name': 'í…ŒìŠ¤íŠ¸ê¸°ì—…1',
                        'event_type': 'ìƒìž¥',
                        'market_type': 'ìœ ê°€ì¦ê¶Œ',
                        'company_id': '20250808001',
                        'source': 'KRX ì‹œë®¬ë ˆì´ì…˜'
                    },
                    {
                        'date': '2025-08-09',
                        'company_name': 'í…ŒìŠ¤íŠ¸ê¸°ì—…2', 
                        'event_type': 'IR',
                        'market_type': 'ì½”ìŠ¤ë‹¥',
                        'company_id': '20250809001',
                        'source': 'KRX ì‹œë®¬ë ˆì´ì…˜'
                    },
                    {
                        'date': '2025-08-10',
                        'company_name': 'í…ŒìŠ¤íŠ¸ê¸°ì—…3',
                        'event_type': 'ìˆ˜ìš”ì˜ˆì¸¡',
                        'market_type': 'ì½”ìŠ¤ë‹¥',
                        'company_id': '20250810001',
                        'source': 'KRX ì‹œë®¬ë ˆì´ì…˜'
                    }
                ]
                
                return mock_events
                
            except Exception as e:
                print(f"âŒ ë°ì´í„° ìˆ˜ì§‘ ì‹¤íŒ¨: {e}")
                return []

        def categorize_events_by_date(events):
            """ë‚ ì§œë³„ ì´ë²¤íŠ¸ ë¶„ë¥˜"""
            today = datetime.now().date()
            
            categorized = {
                'today_events': [],
                'week_events': [],
                'month_events': [],
                'by_type': {
                    'ìƒìž¥': [],
                    'IR': [],
                    'ìˆ˜ìš”ì˜ˆì¸¡': [],
                    'ì²­ì•½': []
                }
            }
            
            for event in events:
                try:
                    event_date = datetime.strptime(event['date'], '%Y-%m-%d').date()
                    days_diff = (event_date - today).days
                    
                    # ë‚ ì§œë³„ ë¶„ë¥˜
                    if days_diff == 0:
                        categorized['today_events'].append(event)
                    elif 0 < days_diff <= 7:
                        categorized['week_events'].append(event)
                    elif 0 <= days_diff <= 30:
                        categorized['month_events'].append(event)
                    
                    # íƒ€ìž…ë³„ ë¶„ë¥˜
                    event_type = event['event_type']
                    if event_type in categorized['by_type']:
                        categorized['by_type'][event_type].append(event)
                        
                except Exception as e:
                    print(f"   âŒ ì´ë²¤íŠ¸ ë¶„ë¥˜ ì‹¤íŒ¨: {e}")
            
            return categorized

        def main():
            print('ðŸ¢ KRX IPO ë°ì´í„° ìˆ˜ì§‘ ì‹œìž‘...')
            
            # ë°ì´í„° ìˆ˜ì§‘ ì‹œë„
            events = create_mock_ipo_data()
            
            if not events:
                print("âŒ ë°ì´í„°ê°€ ì—†ì–´ì„œ ê¸°ë³¸ ë°ì´í„° ìƒì„±")
                events = [{
                    'date': datetime.now().strftime('%Y-%m-%d'),
                    'company_name': 'ë°ì´í„° ì—†ìŒ',
                    'event_type': 'ì •ë³´ì—†ìŒ',
                    'market_type': 'ê¸°íƒ€',
                    'company_id': 'none',
                    'source': 'ê¸°ë³¸ë°ì´í„°'
                }]
            
            # ì´ë²¤íŠ¸ ë¶„ë¥˜
            categorized = categorize_events_by_date(events)
            
            # í†µê³„ ìƒì„±
            stats = {
                'total_events': len(events),
                'today_count': len(categorized['today_events']),
                'week_count': len(categorized['week_events']),
                'month_count': len(categorized['month_events']),
                'by_type_count': {k: len(v) for k, v in categorized['by_type'].items()}
            }
            
            # ìµœì¢… JSON ë°ì´í„°
            final_data = {
                'update_time': datetime.now().strftime('%Yë…„ %mì›” %dì¼ %Hì‹œ %Më¶„'),
                'crawl_time': datetime.now().isoformat(),
                'data_source': 'KRX ê¸°ë°˜ IPO ì‹œìŠ¤í…œ',
                'crawl_method': 'GitHub Actions ìžë™í™”',
                'total_events': len(events),
                'statistics': stats,
                'categorized_events': categorized,
                'all_events': events,
                'status': 'success'
            }
            
            # JSON íŒŒì¼ ì €ìž¥ (íŒŒì¼ëª… í™•ì‹¤ížˆ ìƒì„±)
            output_file = 'ipo_calendar_real.json'
            try:
                with open(output_file, 'w', encoding='utf-8') as f:
                    json.dump(final_data, f, ensure_ascii=False, indent=2)
                print(f'âœ… {output_file} íŒŒì¼ ìƒì„± ì™„ë£Œ')
                
                # íŒŒì¼ ì¡´ìž¬ í™•ì¸
                import os
                if os.path.exists(output_file):
                    file_size = os.path.getsize(output_file)
                    print(f'ðŸ“ íŒŒì¼ í¬ê¸°: {file_size} bytes')
                else:
                    print('âŒ íŒŒì¼ ìƒì„± ì‹¤íŒ¨!')
                    raise Exception("íŒŒì¼ì´ ìƒì„±ë˜ì§€ ì•ŠìŒ")
                    
            except Exception as e:
                print(f'âŒ íŒŒì¼ ì €ìž¥ ì‹¤íŒ¨: {e}')
                raise
            
            # ê²°ê³¼ ì¶œë ¥
            print(f'\nðŸŽ‰ IPO ë°ì´í„° ìˆ˜ì§‘ ì™„ë£Œ!')
            print(f'ðŸ“Š ì´ ì´ë²¤íŠ¸: {len(events)}ê°œ')
            print(f'ðŸ“… ì˜¤ëŠ˜ ì´ë²¤íŠ¸: {stats["today_count"]}ê°œ')
            print(f'ðŸ“ˆ ì´ë²ˆì£¼ ì´ë²¤íŠ¸: {stats["week_count"]}ê°œ')
            print(f'ðŸ• ì—…ë°ì´íŠ¸ ì‹œê°„: {final_data["update_time"]}')
            
        if __name__ == "__main__":
            main()
        EOF
        
    - name: Verify file creation
      run: |
        echo "ðŸ“ ìƒì„±ëœ íŒŒì¼ë“¤ í™•ì¸:"
        ls -la *.json || echo "JSON íŒŒì¼ì´ ì—†ìŠµë‹ˆë‹¤"
        
        if [ -f "ipo_calendar_real.json" ]; then
          echo "âœ… ipo_calendar_real.json íŒŒì¼ ì¡´ìž¬"
          echo "ðŸ“Š íŒŒì¼ ë‚´ìš© ë¯¸ë¦¬ë³´ê¸°:"
          head -20 ipo_calendar_real.json
        else
          echo "âŒ ipo_calendar_real.json íŒŒì¼ì´ ìƒì„±ë˜ì§€ ì•Šì•˜ìŠµë‹ˆë‹¤"
          exit 1
        fi
        
    - name: Commit and push
      run: |
        git config --local user.email "action@github.com"
        git config --local user.name "KRX IPO Crawler"
        
        # íŒŒì¼ ì¡´ìž¬ í™•ì¸ í›„ add
        if [ -f "ipo_calendar_real.json" ]; then
          git add ipo_calendar_real.json
          echo "âœ… íŒŒì¼ staged ì™„ë£Œ"
        else
          echo "âŒ ì»¤ë°‹í•  íŒŒì¼ì´ ì—†ìŠµë‹ˆë‹¤"
          exit 1
        fi
        
        # ë³€ê²½ì‚¬í•­ í™•ì¸ í›„ ì»¤ë°‹
        if git diff --staged --quiet; then
          echo "â„¹ï¸ ë³€ê²½ì‚¬í•­ ì—†ìŒ - ì»¤ë°‹ ìŠ¤í‚µ"
        else
          git commit -m "ðŸ¢ KRX IPO ë°ì´í„° ìžë™ì—…ë°ì´íŠ¸ $(date +'%Y-%m-%d %H:%M')"
          git push
          echo "âœ… ë°ì´í„° ì—…ë°ì´íŠ¸ ì™„ë£Œ"
        fi
