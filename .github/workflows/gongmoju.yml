name: IPO Real Structure Crawler

on:
  schedule:
    - cron: '0 */2 * * *'
  workflow_dispatch:

jobs:
  ipo-real-crawl:
    runs-on: ubuntu-latest
    
    steps:
    - name: Checkout repository
      uses: actions/checkout@v4
      with:
        token: ${{ secrets.GITHUB_TOKEN }}
        
    - name: Setup Python
      uses: actions/setup-python@v4
      with:
        python-version: '3.9'
        
    - name: Install dependencies
      run: |
        pip install requests beautifulsoup4 lxml selenium webdriver-manager
        
    - name: Real structure based crawling
      run: |
        python << 'EOF'
        import requests
        import json
        from datetime import datetime, timedelta
        import time
        import re
        from bs4 import BeautifulSoup
        from urllib.parse import quote

        def extract_company_id(onclick_text):
            """fnDetailView('20250109000190') íŒ¨í„´ì—ì„œ íšŒì‚¬ ID ì¶”ì¶œ"""
            try:
                if 'fnDetailView' in onclick_text:
                    match = re.search(r"fnDetailView\('([^']+)'\)", onclick_text)
                    if match:
                        return match.group(1)
                return None
            except:
                return None

        def get_market_type(img_src):
            """ì´ë¯¸ì§€ ê²½ë¡œë¡œ ì‹œì¥ êµ¬ë¶„ íŒë³„"""
            if not img_src:
                return 'ê¸°íƒ€'
            if 'icn_t_yu.gif' in img_src:
                return 'ìœ ê°€ì¦ê¶Œ'
            elif 'icn_t_ko.gif' in img_src:
                return 'ì½”ìŠ¤ë‹¥'
            else:
                return 'ê¸°íƒ€'

        def crawl_38_calendar_real():
            """38ì»¤ë®¤ë‹ˆì¼€ì´ì…˜ ì‹¤ì œ êµ¬ì¡° ê¸°ë°˜ ë‹¬ë ¥ í¬ë¡¤ë§"""
            try:
                print("ğŸ¢ 38ì»¤ë®¤ë‹ˆì¼€ì´ì…˜ ì‹¤ì œ êµ¬ì¡° ê¸°ë°˜ í¬ë¡¤ë§ ì‹œì‘...")
                
                # í˜„ì¬ ì›”ê³¼ ë‹¤ìŒ ì›” í¬ë¡¤ë§
                current_date = datetime.now()
                all_events = []
                
                for month_offset in range(2):  # ì´ë²ˆ ë‹¬, ë‹¤ìŒ ë‹¬
                    target_date = current_date.replace(day=1) + timedelta(days=32 * month_offset)
                    year = target_date.year
                    month = target_date.month
                    
                    print(f"ğŸ“… {year}ë…„ {month}ì›” í¬ë¡¤ë§ ì¤‘...")
                    
                    # 38ì»¤ë®¤ë‹ˆì¼€ì´ì…˜ ë‹¬ë ¥ URL (ì‹¤ì œ ê²½ë¡œì— ë§ê²Œ ì¡°ì •)
                    url = f"http://www.38.co.kr/html/fund/index.html"
                    params = {
                        'o': 'k',
                        'year': year,
                        'month': f"{month:02d}"
                    }
                    
                    headers = {
                        'User-Agent': 'Mozilla/5.0 (Windows NT 10.0; Win64; x64) AppleWebKit/537.36 (KHTML, like Gecko) Chrome/120.0.0.0 Safari/537.36',
                        'Accept': 'text/html,application/xhtml+xml,application/xml;q=0.9,*/*;q=0.8',
                        'Accept-Language': 'ko-KR,ko;q=0.8,en-US;q=0.5,en;q=0.3',
                        'Accept-Encoding': 'gzip, deflate',
                        'Connection': 'keep-alive',
                        'Referer': 'http://www.38.co.kr/'
                    }
                    
                    try:
                        response = requests.get(url, params=params, headers=headers, timeout=20)
                        if response.status_code == 200:
                            response.encoding = 'euc-kr'  # í•œê¸€ ì¸ì½”ë”© ì²˜ë¦¬
                            soup = BeautifulSoup(response.text, 'html.parser')
                            
                            # ë‹¬ë ¥ í…Œì´ë¸” ì°¾ê¸°
                            calendar_table = soup.find('table')
                            if not calendar_table:
                                print(f"   âŒ {year}-{month:02d} ë‹¬ë ¥ í…Œì´ë¸”ì„ ì°¾ì„ ìˆ˜ ì—†ìŒ")
                                continue
                            
                            # ëª¨ë“  td (ë‚ ì§œ ì…€) ì²˜ë¦¬
                            date_cells = calendar_table.find_all('td')
                            
                            for cell in date_cells:
                                # ë‚ ì§œ ì¶”ì¶œ (ìˆ«ìë§Œ)
                                cell_text = cell.get_text().strip()
                                day_match = re.search(r'(\d+)', cell_text)
                                if not day_match:
                                    continue
                                
                                day = int(day_match.group(1))
                                date_str = f"{year}-{month:02d}-{day:02d}"
                                
                                # í•´ë‹¹ ë‚ ì§œì˜ ì´ë²¤íŠ¸ ë¦¬ìŠ¤íŠ¸ (ul íƒœê·¸)
                                ul = cell.find('ul')
                                if not ul:
                                    continue
                                
                                # ëª¨ë“  li ìš”ì†Œ ì²˜ë¦¬
                                li_elements = ul.find_all('li')
                                current_event_type = None
                                
                                for li in li_elements:
                                    # ì´ë²¤íŠ¸ íƒ€ì… ì²´í¬ (ë°°ê²½ìƒ‰ì´ ìˆëŠ” strong íƒœê·¸)
                                    style = li.get('style', '')
                                    if 'background:#EBF6F8' in style or 'background: #EBF6F8' in style:
                                        strong = li.find('strong')
                                        if strong:
                                            current_event_type = strong.get_text().strip()
                                            print(f"   ğŸ“‹ {date_str} ì´ë²¤íŠ¸ íƒ€ì…: {current_event_type}")
                                            continue
                                    
                                    # íšŒì‚¬ ë§í¬ ì²´í¬
                                    link = li.find('a')
                                    if link and current_event_type:
                                        onclick = link.get('onclick', '')
                                        company_id = extract_company_id(onclick)
                                        
                                        if company_id:
                                            # íšŒì‚¬ëª… ì¶”ì¶œ
                                            company_name = link.get_text().strip()
                                            
                                            # ì‹œì¥ êµ¬ë¶„ ì¶”ì¶œ
                                            img = link.find('img')
                                            market_type = 'ê¸°íƒ€'
                                            if img:
                                                img_src = img.get('src', '')
                                                market_type = get_market_type(img_src)
                                            
                                            # ì´ë²¤íŠ¸ ë°ì´í„° ìƒì„±
                                            event_data = {
                                                'date': date_str,
                                                'day': day,
                                                'event_type': current_event_type,
                                                'company_name': company_name,
                                                'company_id': company_id,
                                                'market_type': market_type,
                                                'month': f"{year}-{month:02d}",
                                                'crawl_time': datetime.now().isoformat(),
                                                'source': '38ì»¤ë®¤ë‹ˆì¼€ì´ì…˜'
                                            }
                                            
                                            all_events.append(event_data)
                                            print(f"   âœ… {date_str} {current_event_type}: {company_name} ({market_type})")
                            
                            print(f"âœ… {year}-{month:02d} ì™„ë£Œ: {len([e for e in all_events if e['month'] == f'{year}-{month:02d}'])}ê°œ ì´ë²¤íŠ¸")
                            
                        else:
                            print(f"   âŒ {year}-{month:02d} HTTP ì˜¤ë¥˜: {response.status_code}")
                            
                        time.sleep(3)  # ì„œë²„ ë¶€í•˜ ë°©ì§€
                        
                    except Exception as e:
                        print(f"   âŒ {year}-{month:02d} í¬ë¡¤ë§ ì‹¤íŒ¨: {e}")
                        continue
                
                return all_events
                
            except Exception as e:
                print(f"âŒ ì „ì²´ í¬ë¡¤ë§ ì‹¤íŒ¨: {e}")
                return []

        def categorize_events_by_date(events):
            """ë‚ ì§œë³„ ì´ë²¤íŠ¸ ë¶„ë¥˜"""
            today = datetime.now().date()
            
            categorized = {
                'today_events': [],      # ì˜¤ëŠ˜
                'week_events': [],       # ì´ë²ˆì£¼ (7ì¼)
                'month_events': [],      # ì´ë²ˆë‹¬
                'upcoming_events': [],   # ì˜ˆì •
                'by_type': {
                    'ìƒì¥': [],
                    'IR': [],
                    'ìˆ˜ìš”ì˜ˆì¸¡': [],
                    'ì²­ì•½': [],
                    'ê¸°íƒ€': []
                }
            }
            
            for event in events:
                try:
                    event_date = datetime.strptime(event['date'], '%Y-%m-%d').date()
                    days_diff = (event_date - today).days
                    
                    # ë‚ ì§œë³„ ë¶„ë¥˜
                    if days_diff == 0:
                        categorized['today_events'].append(event)
                    elif 0 < days_diff <= 7:
                        categorized['week_events'].append(event)
                    elif 0 <= days_diff <= 30:
                        categorized['month_events'].append(event)
                    elif days_diff > 0:
                        categorized['upcoming_events'].append(event)
                    
                    # íƒ€ì…ë³„ ë¶„ë¥˜
                    event_type = event['event_type']
                    if event_type in categorized['by_type']:
                        categorized['by_type'][event_type].append(event)
                    else:
                        categorized['by_type']['ê¸°íƒ€'].append(event)
                        
                except Exception as e:
                    print(f"   âŒ ì´ë²¤íŠ¸ ë¶„ë¥˜ ì‹¤íŒ¨: {e}")
                    categorized['by_type']['ê¸°íƒ€'].append(event)
            
            return categorized

        def get_detailed_company_info(company_id):
            """íšŒì‚¬ ìƒì„¸ ì •ë³´ ìˆ˜ì§‘ (ì œí•œì )"""
            try:
                # ìƒì„¸ ì •ë³´ëŠ” ë‚˜ì¤‘ì— ì¶”ê°€ ê°œë°œ
                return {
                    'description': '',
                    'price_info': '',
                    'schedule_detail': ''
                }
            except:
                return {}

        def main():
            print('ğŸ¢ 38ì»¤ë®¤ë‹ˆì¼€ì´ì…˜ ì‹¤ì œ êµ¬ì¡° ê¸°ë°˜ í¬ë¡¤ë§ ì‹œì‘...')
            
            # ë©”ì¸ í¬ë¡¤ë§
            events = crawl_38_calendar_real()
            print(f"ğŸ“Š ì´ {len(events)}ê°œ ì´ë²¤íŠ¸ ìˆ˜ì§‘ ì™„ë£Œ")
            
            if not events:
                print("âŒ ìˆ˜ì§‘ëœ ì´ë²¤íŠ¸ê°€ ì—†ìŠµë‹ˆë‹¤.")
                return
            
            # ì´ë²¤íŠ¸ ë¶„ë¥˜
            categorized = categorize_events_by_date(events)
            
            # í†µê³„ ìƒì„±
            stats = {
                'total_events': len(events),
                'today_count': len(categorized['today_events']),
                'week_count': len(categorized['week_events']),
                'month_count': len(categorized['month_events']),
                'by_type_count': {k: len(v) for k, v in categorized['by_type'].items()},
                'markets': {}
            }
            
            # ì‹œì¥ë³„ í†µê³„
            for event in events:
                market = event['market_type']
                stats['markets'][market] = stats['markets'].get(market, 0) + 1
            
            # ìµœì¢… JSON ë°ì´í„°
            final_data = {
                'update_time': datetime.now().strftime('%Yë…„ %mì›” %dì¼ %Hì‹œ %Më¶„'),
                'crawl_time': datetime.now().isoformat(),
                'data_source': '38ì»¤ë®¤ë‹ˆì¼€ì´ì…˜ ì‹¤ì œêµ¬ì¡° í¬ë¡¤ë§',
                'crawl_method': 'HTMLë‹¬ë ¥ ì§ì ‘íŒŒì‹±',
                'total_events': len(events),
                'statistics': stats,
                'categorized_events': categorized,
                'all_events': events
            }
            
            # JSON íŒŒì¼ ì €ì¥
            with open('ipo_calendar_real.json', 'w', encoding='utf-8') as f:
                json.dump(final_data, f, ensure_ascii=False, indent=2)
            
            # ê²°ê³¼ ì¶œë ¥
            print(f'\nğŸ‰ ì‹¤ì œ êµ¬ì¡° ê¸°ë°˜ í¬ë¡¤ë§ ì™„ë£Œ!')
            print(f'ğŸ“Š ì´ ì´ë²¤íŠ¸: {len(events)}ê°œ')
            print(f'ğŸ“… ì˜¤ëŠ˜ ì´ë²¤íŠ¸: {stats["today_count"]}ê°œ')
            print(f'ğŸ“ˆ ì´ë²ˆì£¼ ì´ë²¤íŠ¸: {stats["week_count"]}ê°œ')
            print(f'ğŸ¢ ì´ë²ˆë‹¬ ì´ë²¤íŠ¸: {stats["month_count"]}ê°œ')
            print(f'ğŸ“‹ íƒ€ì…ë³„ í†µê³„:')
            for event_type, count in stats['by_type_count'].items():
                print(f'   - {event_type}: {count}ê°œ')
            print(f'ğŸ›ï¸ ì‹œì¥ë³„ í†µê³„:')
            for market, count in stats['markets'].items():
                print(f'   - {market}: {count}ê°œ')
            
        if __name__ == "__main__":
            main()
        EOF
        
    - name: Commit and push results
      run: |
        git config --local user.email "action@github.com"
        git config --local user.name "IPO Real Structure Crawler"
        git add ipo_calendar_real.json
        if git diff --staged --quiet; then
          echo "ë³€ê²½ì‚¬í•­ ì—†ìŒ"
        else
          git commit -m "ğŸ¢ ì‹¤ì œêµ¬ì¡° ê¸°ë°˜ ê³µëª¨ì£¼ ë‹¬ë ¥ í¬ë¡¤ë§ $(date +'%Y-%m-%d %H:%M')"
          git push
          echo "âœ… ì‹¤ì œ êµ¬ì¡° ê¸°ë°˜ ë°ì´í„° ì—…ë°ì´íŠ¸ ì™„ë£Œ"
        fi
